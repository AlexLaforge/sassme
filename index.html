<!doctype html>
<html>
<head>
	<title>SassyColor Test</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<!--[if lt IE 9]>
		<script src="js/lib/html5shiv.js"></script>
	<![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700|Droid+Sans+Mono' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="css/styles.css"  />
	<script src="js/lib/modernizr.custom.min.js"></script>
</head>
<body>

	<header id="header" class="wrapper">
    	<h1>Sass Me</h1>
    	<p>Let's put a quick little description right here about what this does.</p>
	</header>

    <section id="container" class="wrapper">      
        <form action="" method="get" accept-charset="utf-8" class="inactive">
            <ul id="content">
                <li id="colorInput" class="listItem focus">
                    <label for="color">#</label>
                    <input type="text" name="color" id="color" maxlength="6" placeholder="0183B7" />
                    <span id="help">go ahead, insert a hexadecimal value</span>
                </li>
                <li class="listItem">
                	<div id="swatch1" class="swatchContainer">
                		<p class="swatchLabel">input color</p>
                    	<div class="swatch"></div>
                    </div>
                    <div id="swatch2" class="swatchContainer">
                    	<p class="swatchLabel">output color</p>
                    	<div class="swatch"></div>
                    </div>
                    <div id="code">move the sliders to get your code</div>
                    <div class="flyout">
                    	<p>Copy and use the code below:</p>
                    	<input type="text" />
                    	<a class="close">X</a>
                    </div>
                </li>

                <li class="listItem slider">
                    <input type="range" min="0" max="100" id="slider_l" />
                    <label for="slider_l">&larr; darken / lighten &rarr;</label>
                </li>
                <li class="listItem slider">
                    <input type="range" min="0" max="100" id="slider_s" />
                    <label for="slider_s">&larr; desaturate / saturate &rarr;</label>
                </li>
                <li class="listItem slider">
                    <input type="range" min="0" max="360" id="slider_h" />
                    <label for="slider_h">&larr; adjust hue &rarr;</label>
                </li>
            </ul>
        </form>
    </section>

    <footer id="footer" class="wrapper">
    	<img src="img/arc90-logo.png" alt="Arc90" />
    	<p>A tool from the <a href="">Arc90 Lab</a></p>
    	<p>Source is on <a href="">Github</a></p>
    	<p id="kindling">SASS Me inspired by social innovation software <a href="http://kindlingapp.com/">Kindling</a>.</p>
    	<img src="img/kindling.png" alt="Kindling - Social Innovation Software" />
    </footer>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="js/lib/jquery-ui-min.js"></script>
	<script src="js/lib/underscore-min.js"></script>
	<script src="js/Color.js"></script>
	<script src="js/Transforms.js"></script>
	<script>
		// Here Be the Magic!
		$(function(){
			// Do we have native HTML5 sliders?
			var hasRange = Modernizr.inputtypes.range;

			// use jQuery UI to handle it for us.
			if (!hasRange) {
				var $ranges = $('input[type="range"]');
				
				$ranges.each(function (i, r) {
					var $r   	 = $(r),
						rangeID  = $r.attr('id'),
						rangeMin = $r.attr('min'),
						rangeMax = $r.attr('max');

					r.style.display = 'none';
					$r.removeAttr('id');

					$('<div id="'+rangeID+'">').slider({ max : rangeMax, min : rangeMin }).insertAfter(r);
				});
			} 

			// Cache jQuery selectors
			var $slider_l = $('#slider_l'), // Slider: Lightness
				$slider_s = $('#slider_s'), // Slider: Saturation
				$slider_h = $('#slider_h'), // Slider: Hue
				$color    = $('#color'), // Color input
				$swatchA  = $('#swatch1 div'),
				$swatchB  = $('#swatch2 div'),
				$code     = $('#code') // SASS code output

			// Maintain state on our swatches
			var swatchA = swatchB = {};

			// Template for SASS functions. We can nest these to make
			// compound functions
			var tpl = _.template("<%= func %>(<%= value %>, <%= transform %>)");

			// Hoist variables matey!
			var direction, start_color, prev, current, base, stack, sliders, transforms;

			// Define some storage vars
			stack = [];
			sliders = {
				slider_h : {},
				slider_s : {},
				slider_l : {}
			};

			// These are the transform methods used by the sliders. We have
			// them in an object so we can call them easily from a loop
			// using the id's of the inputs themselves as hooks.
			transforms = {

				// Lighten/Darken
				slider_l : function(val, base_color) {
					var t;
					if (val < 0) {
						// Darken
						t = Transforms.darken(base_color, Math.abs(val));
						return {
							color : new Color(t),
							func  : 'darken',
							value : Math.abs(val)
						}
					} else if (val > 0) {
						// Lighten
						t = Transforms.lighten(base_color, Math.abs(val));
						return {
							color : new Color(t),
							func  : 'lighten',
							value : Math.abs(val)
						}
					} else if (val === 0) {
						stack_remove('slider_l');
						return {
							color : base_color,
							func  : null,
							value : null
						}
					}
				},

				// Saturate/Desaturate
				slider_s : function(val, base_color) {
					var t;
					if (val < 0) {
						// Darken
						t = Transforms.desaturate(base_color, Math.abs(val));
						return {
							color : new Color(t),
							func  : 'desaturate',
							value : Math.abs(val)
						}
					} else if (val > 0) {
						// Lighten
						t = Transforms.saturate(base_color, Math.abs(val));
						return {
							color : new Color(t),
							func  : 'saturate',
							value : Math.abs(val)
						}
					} else if (val === 0) {
						stack_remove('slider_s');
						return {
							color : base_color,
							func  : null,
							value : null
						}
					}
				},

				// Adjust Hue
				slider_h : function(val, base_color) {
					var t;
					t = Transforms.adjust_hue(base_color, Math.abs(val));
					return {
						color : new Color(t),
						func  : 'adjust_hue',
						value : Math.abs(val)
					}
				}
			}

			// =================
			// Page interactions
			// =================

			// On page load, focus the color input
			$('#color').focus();

			// Give the input color's <li> a class of focus when #color is in focus
			$('#color').focus(function(){
				$(this).parent().addClass('focus');
			}).blur(function(){
				$(this).parent().removeClass('focus');
			});

			// give the form a class of 'active' when the color is validated
			$('#color').keyup(function(){
				colorValue = $(this).val();
				// when it hits 6 characters, fill everything in in the form
				if (  colorValue.length > 5 ) {
					init(colorValue); // Initialize the application
					$('form').removeClass('inactive');
					$('form').addClass('active');
				} else {
					$('form').addClass('inactive');
					$('form').removeClass('active');
				}
			});

			// Clicking the code will open a flyout with a preselected
			// input for easy copypasta
			$('#code').click(function(){
				var text = $(this).text();
				$('.flyout input').empty().val(text);
				$('.flyout').fadeIn( function() {
					$('.flyout input').select();
					$('.flyout a').on('click', function(){
						$('.flyout').fadeOut('fast');
					});
				});		
			});

			// ==================
			// Event Handling
			// ==================

			$swatchA.on('transform', function(event, color){
				$(event.target).css('background-color', color.hex);
				$(event.target).html(color.hex);
			});

			$swatchB.on('transform', function(event, color){
				$(event.target).css('background-color', color.hex);
				$(event.target).html(color.hex);
			});

			// ==================
			// Color Calculations
			// ==================

			// Initialize the swatches
			function init(color) {
				start_color = new Color(color);
				$swatchA.trigger('transform', [start_color]);
				$swatchB.trigger('transform', [start_color]);

				// Initialize sliders
				if (!hasRange) {
					// No Sliders? No problem! jQuery UI for you.
					$slider_l.slider( "option", "value", start_color.hsl.l);
					$slider_s.slider( "option", "value", start_color.hsl.s);
					$slider_h.slider( "option", "value", start_color.hsl.h);
				} else {
					$slider_l.val(start_color.hsl.l);
					$slider_s.val(start_color.hsl.s);
					$slider_h.val(start_color.hsl.h);
				}

				// Initialize storage units
				sliders.slider_l.start_val = start_color.hsl.l;
				sliders.slider_s.start_val = start_color.hsl.s;
				sliders.slider_h.start_val = start_color.hsl.h;
			}

			// Push a slider reference onto the stack - unless it
			// already exists
			function stack_add(id) {
				if (!_.find(stack, function(item){ return item === id })) {
					stack.push(id);
				}
			}

			// Remove an existing slider reference from the stack
			function stack_remove(id) {
				var index = _.indexOf(stack, id);
				removed = stack.splice(index, 1);
			}

			// Branch how we handle the sliders depending on wether
			// native HTML5 controls are present or we're using
			// jQuery sliders.
			if (!hasRange) {
				$('.ui-slider').on('slide', function(e) {
					var $el = $(e.target);
					var val = $(this).slider('option', 'value');
					var id  = $el.attr('id');
					deriveTransformation($el, val, id);	
				});
			} else {
				$('form').on('change', 'input[type=range]', function(e) {
					var $el = $(e.target); 
					var val = $el.val(); 
					var id  = $el.attr('id');
					deriveTransformation($el, val, id);
				});
			}

			// Take the slider inputs and derive the SASS functions
			// from the HSL colors they create using the start color
			// as the transform point.
			function deriveTransformation($el, val, id) {
				stack_add(id);

				if (id !== 'slider_h') {
					increment = val - sliders[id].start_val;
				} else {
					increment = val;
				}

				sliders[id].increment = increment; // Store this for use below

				// Walk the stack and determine what our base colors should be.
				// Then build the function stack
				var output_color = start_color;
				var output_value;
				var transform;

				// Use reduce to iterate over the stack and derive our
				// final output color. We like it functional yo!
				output_value = _.reduce(stack, function(memo, func) {
					// if (func !== undefined) {
						transform = transforms[func](sliders[func].increment, output_color);
						output_color = transform.color;
						if (memo === undefined) {
							if (transform.func === null) {
								return start_color.hex;
							} else {
								return tpl({
									'func'      : transform.func,
									'value'     : start_color.hex,
									'transform' : transform.value
								});
							}
						} else {
							if (transform.func === null) {
								return memo;
							} else {
								return tpl({
									'func'      : transform.func,
									'value'     : memo,
									'transform' : transform.value
								});
							}
						}
					// }
				}, start_color.hex)

				$code.html(output_value);
				$swatchB.trigger('transform', [output_color]);

			}

		});
	</script>
	<!-- 
		
		 _______  _______  _______  _______  __   __  _______ 
		|       ||   _   ||       ||       ||  |_|  ||       |
		|  _____||  |_|  ||  _____||  _____||       ||    ___|
		| |_____ |       || |_____ | |_____ |       ||   |___ 
		|_____  ||       ||_____  ||_____  ||       ||    ___|
		 _____| ||   _   | _____| | _____| || ||_|| ||   |___ 
		|_______||__| |__||_______||_______||_|   |_||_______|

	 -->
</body>
</html>